# Настройка Supabase для проекта ОНА

Это руководство поможет вам настроить проект Supabase для использования с Telegram-ботом ОНА.

## Содержание

1. [Создание проекта Supabase](#создание-проекта-supabase)
2. [Настройка базы данных](#настройка-базы-данных)
3. [Создание таблиц и политик](#создание-таблиц-и-политик)
4. [Настройка аутентификации](#настройка-аутентификации)
5. [Настройка Edge Functions](#настройка-edge-functions)
6. [Получение API-ключей](#получение-api-ключей)
7. [Интеграция с ботом](#интеграция-с-ботом)

## Создание проекта Supabase

1. Перейдите на [app.supabase.com](https://app.supabase.com/) и войдите в свой аккаунт (или зарегистрируйтесь).
2. Нажмите кнопку "New Project".
3. Введите название проекта (например, "ona-bot").
4. Выберите регион, ближайший к вашим пользователям (например, "Western Europe" для пользователей из России).
5. Установите надежный пароль для базы данных.
6. Нажмите "Create new project".

Создание проекта займет несколько минут.

## Настройка базы данных

После создания проекта перейдите в раздел SQL Editor:

1. В меню слева выберите "SQL Editor".
2. Нажмите "New Query".
3. Скопируйте содержимое файла `supabase/schema.sql` из репозитория проекта.
4. Вставьте код в редактор и нажмите "Run".

Это создаст все необходимые таблицы и настройки безопасности для работы бота.

## Создание таблиц и политик

Проверьте, что следующие таблицы были успешно созданы:

1. `profiles` - хранит профили пользователей
2. `survey_responses` - хранит ответы на вопросы опроса
3. `reminders` - хранит напоминания пользователей
4. `user_stats` - хранит статистику использования
5. `conversations` - хранит историю диалогов

Также проверьте, что для всех таблиц включена Row Level Security (RLS) и созданы соответствующие политики.

## Настройка аутентификации

Для интеграции с Telegram мы будем использовать JWT-аутентификацию:

1. В меню слева выберите "Authentication".
2. Перейдите в раздел "Providers".
3. Убедитесь, что включен провайдер "Email" (для тестирования).
4. В разделе "JWT Settings" скопируйте JWT Secret (он понадобится для настройки бота).

## Настройка Edge Functions

Для работы с OpenAI API и другими внешними сервисами мы будем использовать Supabase Edge Functions:

1. Установите Supabase CLI на свой компьютер, следуя [официальному руководству](https://supabase.com/docs/guides/cli).
2. Авторизуйтесь в CLI командой `supabase login`.
3. Инициализируйте проект в локальной директории: `supabase init`.
4. Свяжите локальный проект с удаленным: `supabase link --project-ref YOUR_PROJECT_ID`.
5. Скопируйте содержимое директории `supabase/functions` из репозитория в вашу локальную директорию.
6. Разверните функции командой: `supabase functions deploy --project-ref YOUR_PROJECT_ID`.

### Настройка секретов для Edge Functions

Для работы Edge Functions нужно настроить переменные окружения:

```bash
supabase secrets set OPENAI_API_KEY=ваш_ключ_openai --project-ref YOUR_PROJECT_ID
supabase secrets set ELEVENLABS_API_KEY=ваш_ключ_elevenlabs --project-ref YOUR_PROJECT_ID
```

## Получение API-ключей

Для интеграции с ботом вам понадобятся следующие ключи:

1. В меню слева выберите "Project Settings".
2. Перейдите в раздел "API".
3. Скопируйте "anon public" ключ (будет использоваться как `SUPABASE_KEY`).
4. Скопируйте URL проекта (будет использоваться как `SUPABASE_URL`).

## Интеграция с ботом

1. Откройте файл `.env` в корневой директории бота.
2. Добавьте следующие переменные:

```
SUPABASE_URL=ваш_url_supabase
SUPABASE_KEY=ваш_ключ_supabase
```

3. Перезапустите бота.

## Проверка работоспособности

Для проверки работоспособности интеграции с Supabase:

1. Запустите бота командой `python main.py`.
2. Отправьте боту команду `/start`.
3. Проверьте логи на наличие ошибок подключения к Supabase.
4. В Supabase Dashboard перейдите в раздел "Table Editor" и проверьте, что создаются записи в таблице `profiles` при взаимодействии с ботом.

## Дополнительные настройки

### Настройка бэкапов

Рекомендуется настроить регулярные бэкапы базы данных:

1. В меню слева выберите "Project Settings".
2. Перейдите в раздел "Database".
3. Настройте расписание бэкапов (рекомендуется ежедневный бэкап).

### Мониторинг

Для мониторинга производительности и ошибок:

1. В меню слева выберите "Reports".
2. Здесь вы можете отслеживать использование API, ошибки и производительность. 